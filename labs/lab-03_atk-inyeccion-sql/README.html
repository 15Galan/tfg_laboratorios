<p>Un ataque de inyección SQL es un tipo de ataque de inyección de código que se dirige a las aplicaciones que utilizan bases de datos de tipo SQL; este ataque se realiza <strong>introduciendo un código SQL malicioso en las declaraciones SQL de entrada de una aplicación web</strong>.</p>

<p>Una inyección exitosa puede:</p>

<ul>
<li>Leer información confidencial de una base de datos.</li>

<li>Modificar la información de una base de datos (insertar / actualizar / eliminar).</li>

<li>Ejecutar operaciones administrativas en una base de datos (como apagar el DBMS).</li>

<li>Recuperar el contenido del sistema de archivos, o incluso enviar comandos al sistema operativo.</li>
</ul>

<blockquote>
  <p><strong>Nota</strong> <br />
  Un DBMS (<em>Database Management System</em>) es un sistema de gestión de bases de datos; es decir, un software que permite crear y administrar bases de datos.</p>
  
  <p>Ejemplos conocidos: MySQL, MariaDB, PostgreSQL, Microsoft SQL Server, Oracle Database, SQLite...</p>
</blockquote>

<h2 id="tiposdeinyeccinsql">Tipos de inyección SQL</h2>

<p>Existen muchos tipos de inyección SQL, pero los más comunes son:</p>

<ul>
<li><strong>Basada en errores</strong>: se basa en errores de sintaxis de SQL. El atacante introduce un código SQL malicioso que provoca un error de sintaxis en la consulta SQL; este error revela información sobre la estructura de la consulta SQL y, por lo tanto, sobre la estructura de la base de datos.</li>

<li><strong>Basada en uniones</strong>: se basa en la unión de tablas. El atacante introduce un código SQL malicioso con el que une a una tabla de la base de datos que no está destinada a la consulta SQL original; el resultado de la consulta SQL se combina con el resultado de la consulta SQL original y se devuelve al atacante.</li>

<li><strong>Basada en tiempo</strong>: se basa en el tiempo de respuesta de la consulta SQL. El atacante introduce un código SQL malicioso que provoca un retraso en la respuesta de la consulta SQL; el retraso revela información sobre la estructura de la consulta SQL y, por lo tanto, sobre la estructura de la base de datos.</li>

<li><strong>Basada en booleanos</strong>: se basa en el resultado de la consulta SQL. El atacante introduce un código SQL malicioso que provoca un resultado de consulta SQL verdadero o falso; el resultado revela información sobre la estructura de la consulta SQL y, por lo tanto, sobre la estructura de la base de datos.</li>
</ul>

<h2 id="ejemplo">Ejemplo</h2>

<p>Supongamos que tenemos una aplicación web que permite a los usuarios iniciar sesión con un nombre de usuario y una contraseña. La aplicación web utiliza una base de datos de tipo SQL para almacenar las credenciales de los usuarios.</p>

<p>La aplicación web utiliza la siguiente consulta SQL para verificar si el nombre de usuario y la contraseña proporcionados por el usuario son válidos:</p>

<pre><code class="sql language-sql">SELECT * FROM users WHERE username = '&lt;username&gt;' AND password = '&lt;password&gt;'
</code></pre>

<ul>
<li>Si el nombre y contraseñas <strong>son válidos</strong>, se devuelve una fila d e<code>users</code>.</li>

<li>Si el nombre y contraseñas <strong>no son válidos</strong>, no se devuelve ninguna fila.</li>
</ul>

<p>Ahora, supongamos que el usuario introduce el siguiente nombre de usuario y contraseña:</p>

<ul>
<li>Usuario: <code>administrador</code></li>

<li>Contraseña: <code>contraseña' OR '1' = '1</code></li>
</ul>

<p>La aplicación web utiliza la siguiente consulta SQL para verificar si el nombre de usuario y la contraseña proporcionados por el usuario son válidos:</p>

<pre><code class="sql language-sql">SELECT * FROM users WHERE username = 'administrador' AND password = 'contraseña' OR '1' = '1'
</code></pre>

<ul>
<li>Si el nombre y contraseñas <strong>son válidos</strong>, se devuelve una fila de <code>users</code>.</li>

<li>Si el nombre y contraseñas <strong>no son válidos</strong>, no se devuelve ninguna fila.</li>

<li>Si la expresión $1 = 1$ es <strong>verdadera</strong>, se devuelve una fila de <code>users</code>.</li>
</ul>

<p>La consulta SQL devuelve una fila de la tabla <code>users</code>, por lo que la aplicación web permite al usuario iniciar sesión.</p>

<blockquote>
  <p><strong>Nota</strong> <br />
  El truco está en que la expresión $1 = 1$ siempre es cierta, por lo que al comprobar si <em>el usuario está registrado o $1 = 1$ es cierto</em>, <strong>siempre se devuelve una fila de <code>users</code></strong> porque $1 = 1$ siempre es cierto.</p>
</blockquote>

<p>El atacante ha utilizado una inyección SQL para engañar a la aplicación web y obtener acceso a la cuenta de administrador sin conocer la contraseña del administrador.</p>

<h3 id="vulnerabilidad">Vulnerabilidad</h3>

<p>La vulnerabilidad del ejemplo anterior se produce porque la aplicación web no valida los datos de entrada del usuario antes de utilizarlos en una consulta SQL, lo que le permite a un usuario introducir caracteres especiales que alteran el significado de la consulta SQL.</p>

<h3 id="explotacin">Explotación</h3>

<p>Esta es la consulta del ejemplo anterior:</p>

<pre><code class="sql language-sql">SELECT * FROM users WHERE username = '&lt;username&gt;' AND password = '&lt;password&gt;'
</code></pre>

<p>Se necesita colocar una sentencia SQL entre el último carácter de <code>&lt;password&gt;</code> y la comilla <code>'</code> que <em>cierra</em> la contraseña.</p>

<p>La sentencia a colocar, para que encaje bien, debe empezar o contener una comilla <code>'</code> (para que <em>cierre</em> la contraseña) y terminar sin comilla <code>'</code> (porque se usará la que tenía la contraseña).</p>

<p>Por eso <code>contraseña' OR '1' = '1</code> encaja bien.</p>

<h1 id="laboratorio">Laboratorio</h1>

<p>Este laboratorio contiene la web <strong>DVWA</strong>, usada para aprender sobre vulnerabilidades web. </p>

<p>Si bien contiene vulnerabilidades de varios tipos, el objetivo de este apartado es la sección de Inyección SQL.</p>

<h2 id="sobredvwa">Sobre DVWA</h2>

<p>DVWA (<em>Damn Vulnerable Web App</em>) es una aplicación web PHP / MySQL de código abierto que es vulnerable de muchas formas. Su objetivo es ser un ejercicio de aprendizaje para ayudar a los desarrolladores web a probar vulnerabilidades con mayor facilidad.</p>

<p><img src="./resources/DVWA-inyeccion.png" alt="inyeccion" /></p>

<p>Esta aplicación web cuenta con 4 niveles de dificultad: bajo, medio, difícil e imposible. El nivel de dificultad afecta a toda la página y por tanto, a todas las vulnerabilidades que contiene.</p>

<p><strong>Se ha configurado la aplicación para que se ejecute en <em>dificultad baja</em> por defecto</strong>, aunque puede configurarse en la sección <em>DVWA Security</em> del menú izquierdo:</p>

<p><img src="./resources/DVWA-dificultad.png" alt="dificultad" /></p>

<h2 id="preparacin">Preparación</h2>

<p>Credenciales del administrador:</p>

<ul>
<li>Usuario: <code>admin</code>.</li>

<li>Contraseña: <code>password</code>.</li>
</ul>

<p><img src="./resources/DVWA-login.png" alt="login" /></p>

<p>Al acceder por primera vez a DVWA tendrás que inicializar su base de datos, para ello, simplemente:</p>

<ol>
<li>Inicia sesión como administrador.</li>

<li>Pulsa el botón <kbd>Create / Reset Database</kbd></li>

<li>Vuelve a iniciar sesión como administrador.</li>
</ol>

<p><img src="./resources/DVWA-inicio.png" alt="inicio" /></p>

<p>Una vez hecho eso, DVWA está activa y lista para usar.</p>

<blockquote>
  <p><strong>Recuerda</strong> <br />
  Tendrás que repetir estos simples pasos cada vez que inicies este laboratorio.</p>
</blockquote>

<h1 id="referencias">Referencias</h1>

<p><img src="https://www.mclibre.org/consultar/php/img/otros/exploits-of-a-mom.png" alt="Manu Tablas" /></p>

<ul>
<li><a href="https://github.com/digininja/DVWA">Repositorio ofiicial de DVWA</a></li>

<li><a href="https://en.wikipedia.org/wiki/SQL_injection">Inyección SQL en Wikipedia (EN)</a></li>
</ul>
